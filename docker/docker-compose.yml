version: '3'
services:
    frontend:
        build:
            context: ..
            dockerfile: ./docker/nginx.DockerFile
        depends_on:
            - pin-writer
            - pin-reader
        ports:
            # NOTE only expose service frontend to outside world
            # https://docs.docker.com/compose/compose-file/#ports
            # https://docs.docker.com/compose/compose-file/#expose
            - '${PIN_HOST_ADDR}:${PIN_FRONTEND_SERVER_PORT}'
        networks:
            - pin-network
    pin-writer:
        build:
            # paths are relative to the location of compose file
            context: ..
            dockerfile: ./docker/writer.DockerFile # NOTE relative to the context root
            # depends_on:
            # NOTE docker only guarantee startup and termination order on container level, not on service level
            # TODO: db
        environment:
            - PIN_WRITER_VERBOSE
            - PIN_WRITER_SERVER_ADDR
            - PIN_TRAP_NAME
            - COUCHDB_ADDR
            - COUCHDB_USER_APP
            - COUCHDB_PASSWORD_APP
            - DB_NAME_PIN
            - DB_NAME_PIN_META
            - DB_NAME_USER
        ports:
            - '${PIN_WRITER_SERVER_PORT}'
        networks:
            - pin-network
    pin-reader:
        build:
            context: ..
            dockerfile: ./docker/reader.DockerFile
            # depends_on:
            # TODO: db
        environment:
            - PIN_READER_VERBOSE
            - PIN_READER_SERVER_ADDR
        ports:
            - '${PIN_READER_SERVER_PORT}'
        networks:
            - pin-network
    pin-db:
        image: couchdb:3
        environment:
            - COUCHDB_USER
            - COUCHDB_PASSWORD
        networks:
            - pin-network
    db-populator:
        build:
            context: ..
            dockerfile: ./docker/db-populator.DockerFile
        environment:
            - COUCHDB_ADDR
            - COUCHDB_USER
            - COUCHDB_PASSWORD
            - COUCHDB_USER_APP
            - COUCHDB_PASSWORD_APP
            - DB_NAME_PIN
            - DB_NAME_PIN_META
            - DB_NAME_USER
        depends_on:
            - pin-db
        networks:
            - pin-network
networks:
    pin-network:
